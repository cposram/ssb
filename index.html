<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è›‹è›‹æ˜æ˜Ÿå¤§äº‚é¬¥ - ä¸‹æ‹‰é‡é–‹ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            /* å…è¨±ç€è¦½å™¨é è¨­çš„ä¸‹æ‹‰è¡Œç‚ºï¼Œæˆ–è€…é€é JS æ§åˆ¶ */
            overscroll-behavior-y: contain; 
            touch-action: none; /* æˆ‘å€‘æ‰‹å‹•è™•ç†è§¸æ‘¸äº‹ä»¶ */
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        canvas {
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            max-width: 100%;
            max-height: 65vh;
            border: 5px solid #fff;
            border-radius: 10px;
        }

        /* ä¸‹æ‹‰æç¤º */
        #refresh-hint {
            position: absolute;
            top: -50px;
            width: 100%;
            text-align: center;
            color: white;
            font-weight: bold;
            transition: top 0.2s;
            z-index: 200;
        }

        /* UI ä»‹é¢ */
        #ui-overlay {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            pointer-events: none;
        }
        .hp-bar-outer { width: 150px; height: 20px; background: #333; border: 2px solid #fff; border-radius: 15px; overflow: hidden; }
        .hp-fill { width: 100%; height: 100%; background: #2ed573; transition: width 0.3s; }
        .label { color: white; text-shadow: 2px 2px 4px black; text-align: center; margin-bottom: 5px; font-weight: bold; }

        /* çµç®—ç•«é¢ */
        #result-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
        }
        #result-title { font-size: 48px; margin-bottom: 20px; }
        .restart-btn {
            padding: 12px 30px;
            font-size: 20px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
        }

        /* æ‰‹æ©ŸæŒ‰éˆ• */
        #controls {
            display: flex;
            justify-content: space-between;
            width: 95%;
            max-width: 500px;
            margin-top: 10px;
        }
        .btn-group { display: flex; gap: 10px; }
        .ctrl-btn {
            width: 65px; height: 65px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 20px;
            user-select: none; border: 2px solid #444;
        }
        .attack-btn { background: #ff4757; color: white; width: 75px; height: 75px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="refresh-hint">â¬‡ï¸ é‡‹æ”¾ä»¥é‡æ–°æ•´ç†ç¶²é  â¬‡ï¸</div>

    <div id="ui-overlay">
        <div>
            <div class="label">ç©å®¶ ğŸ¥š</div>
            <div class="hp-bar-outer"><div id="p1-hp" class="hp-fill"></div></div>
        </div>
        <div>
            <div class="label">é›»è…¦ ğŸ¤–</div>
            <div class="hp-bar-outer"><div id="p2-hp" class="hp-fill" style="background: #ffa502;"></div></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="result-screen">
        <div id="award-icon" style="font-size: 80px;">ğŸ†</div>
        <div id="result-title">ä½ è´äº†ï¼</div>
        <button class="restart-btn" onclick="resetGame()">å†æˆ°ä¸€å ´</button>
        <p style="margin-top: 20px; color: #aaa;">(æˆ–è€…ä¸‹æ‹‰ç¶²é é‡æ–°é–‹å§‹)</p>
    </div>

    <div id="controls">
        <div class="btn-group">
            <div class="ctrl-btn" id="btn-left">â†</div>
            <div class="ctrl-btn" id="btn-right">â†’</div>
        </div>
        <div class="btn-group">
            <div class="ctrl-btn" id="btn-jump">è·³</div>
            <div class="ctrl-btn attack-btn" id="btn-attack">âš”ï¸</div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const resultScreen = document.getElementById('result-screen');
    const refreshHint = document.getElementById('refresh-hint');

    canvas.width = 800;
    canvas.height = 500;

    // --- ä¸‹æ‹‰é‡æ–°æ•´ç†é‚è¼¯ ---
    let touchStartY = 0;
    let isPulling = false;

    window.addEventListener('touchstart', e => {
        touchStartY = e.touches[0].pageY;
    }, {passive: false});

    window.addEventListener('touchmove', e => {
        const touchY = e.touches[0].pageY;
        const pullDist = touchY - touchStartY;

        // å¦‚æœåœ¨è¢å¹•ä¸Šæ–¹å¾€ä¸‹æ‹‰
        if (pullDist > 50 && window.scrollY === 0) {
            isPulling = true;
            refreshHint.style.top = '20px'; // é¡¯ç¤ºæç¤º
            if (pullDist > 150) refreshHint.innerText = "ğŸ”¥ æ”¾é–‹ç«‹å³é‡å•ŸéŠæˆ² ğŸ”¥";
        } else {
            refreshHint.style.top = '-50px';
        }
    }, {passive: false});

    window.addEventListener('touchend', e => {
        const touchEndY = e.changedTouches[0].pageY;
        if (isPulling && (touchEndY - touchStartY) > 150) {
            // åŸ·è¡Œé‡æ–°æ•´ç†ç¶²é 
            location.reload();
        }
        isPulling = false;
        refreshHint.style.top = '-50px';
        refreshHint.innerText = "â¬‡ï¸ é‡‹æ”¾ä»¥é‡æ–°æ•´ç†ç¶²é  â¬‡ï¸";
    });

    // --- éŠæˆ²é‚è¼¯ ---
    const gravity = 0.8;
    const friction = 0.8;
    let gameActive = true;

    const platforms = [
        { x: 150, y: 380, w: 500, h: 25 }, 
        { x: 80, y: 240, w: 160, h: 15 }, 
        { x: 560, y: 240, w: 160, h: 15 }, 
        { x: 325, y: 130, w: 150, h: 15 }
    ];

    class Egg {
        constructor(x, y, color, isNPC) {
            this.initialX = x; this.initialY = y;
            this.color = color; this.isNPC = isNPC;
            this.width = 40; this.height = 50;
            this.reset();
        }
        reset() {
            this.x = this.initialX; this.y = this.initialY;
            this.dx = 0; this.dy = 0; this.hp = 100;
            this.facing = this.isNPC ? -1 : 1;
            this.isAttacking = false; this.attackCooldown = 0; this.jumpCount = 0;
        }
        draw() {
            if (this.isAttacking) {
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                ctx.rotate(this.facing * Math.PI / 4);
                ctx.fillRect(0, -5, 60 * this.facing, 10);
                ctx.restore();
            }
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.ellipse(this.x + this.width/2, this.y + this.height/2, this.width/2, this.height/2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "#000"; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = "#000";
            let eyeX = this.x + (this.facing === 1 ? 25 : 10);
            ctx.beginPath(); ctx.arc(eyeX, this.y + 15, 4, 0, Math.PI * 2); ctx.fill();
        }
        update() {
            this.dy += gravity; this.x += this.dx; this.y += this.dy; this.dx *= friction;
            platforms.forEach(p => {
                if (this.x + this.width > p.x && this.x < p.x + p.w &&
                    this.y + this.height > p.y && this.y + this.height < p.y + p.h + this.dy) {
                    if (this.dy >= 0) { this.dy = 0; this.y = p.y - this.height; this.jumpCount = 0; }
                }
            });
            if (this.x < 0) this.x = 0;
            if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
            if (this.y > canvas.height) { this.hp -= 25; this.y = 0; this.dx = 0; updateHPUI(); }
            if (this.attackCooldown > 0) this.attackCooldown--;
            if (this.attackCooldown < 15) this.isAttacking = false;
        }
        attack() {
            if (this.attackCooldown === 0) { this.isAttacking = true; this.attackCooldown = 30; return true; }
            return false;
        }
    }

    const player = new Egg(200, 300, "#ffffff", false);
    const npc = new Egg(550, 300, "#f1c40f", true);

    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    let mLeft = false, mRight = false;
    function bind(id, d, u) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', e => { e.preventDefault(); d(); });
        el.addEventListener('touchend', e => { e.preventDefault(); if(u) u(); });
    }
    bind('btn-left', () => mLeft = true, () => mLeft = false);
    bind('btn-right', () => mRight = true, () => mRight = false);
    bind('btn-jump', () => { if(player.jumpCount < 2) { player.dy = -13; player.jumpCount++; } });
    bind('btn-attack', () => player.attack());

    function updateHPUI() {
        document.getElementById('p1-hp').style.width = Math.max(0, player.hp) + '%';
        document.getElementById('p2-hp').style.width = Math.max(0, npc.hp) + '%';
    }

    function checkHit(attacker, victim) {
        if (attacker.isAttacking && attacker.attackCooldown === 25) {
            const hitRange = 70;
            const attackerMidX = attacker.x + attacker.width/2;
            const reach = attackerMidX + (attacker.facing * hitRange);
            if (victim.x < Math.max(attackerMidX, reach) && victim.x + victim.width > Math.min(attackerMidX, reach) && Math.abs(attacker.y - victim.y) < 60) {
                victim.hp -= 15; victim.dx = attacker.facing * 20; victim.dy = -5; updateHPUI();
            }
        }
    }

    function gameLoop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (keys['ArrowLeft'] || mLeft) { player.dx = -6; player.facing = -1; }
        if (keys['ArrowRight'] || mRight) { player.dx = 6; player.facing = 1; }
        if (keys['Space'] || keys['ArrowUp']) { if(player.jumpCount === 0) { player.dy = -13; player.jumpCount = 1; } }
        if (keys['KeyZ']) player.attack();

        // AI
        const dist = player.x - npc.x;
        if (Math.abs(dist) > 70) { npc.dx = dist > 0 ? 3.5 : -3.5; npc.facing = dist > 0 ? 1 : -1; }
        else { if (Math.random() < 0.06) npc.attack(); }

        player.update(); npc.update();
        checkHit(player, npc); checkHit(npc, player);

        ctx.fillStyle = "#2f3542";
        platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
        player.draw(); npc.draw();

        if (player.hp <= 0) { gameActive = false; resultScreen.style.display = 'flex'; document.getElementById('result-title').innerText = "å¤§å¤±æ•—ï¼"; }
        else if (npc.hp <= 0) { gameActive = false; resultScreen.style.display = 'flex'; document.getElementById('result-title').innerText = "å‹åˆ©ï¼"; }
        else requestAnimationFrame(gameLoop);
    }

    function resetGame() {
        player.reset(); npc.reset(); updateHPUI();
        resultScreen.style.display = 'none'; gameActive = true; gameLoop();
    }

    gameLoop();
</script>
</body>
</html>
