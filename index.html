<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿è€…æ­¦å£«ï¼šæŒ‡æ»‘å¤§äº‚é¬¥</title>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #1a1a1a;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            touch-action: none;
            overscroll-behavior-y: contain;
        }
        #game-container {
            position: relative; width: 100vw; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        canvas {
            background: #2c3e50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-width: 100%; max-height: 80vh;
            border: 4px solid #333;
        }
        /* ä¸‹æ‹‰æç¤º */
        #refresh-hint {
            position: absolute; top: -60px; width: 100%; text-align: center;
            color: #ff4757; font-weight: bold; transition: 0.3s; z-index: 200;
        }
        /* è¡€æ¢ */
        #ui-overlay {
            position: absolute; top: 20px; width: 100%;
            display: flex; justify-content: space-around; pointer-events: none;
        }
        .hp-box { text-align: center; }
        .hp-bar { width: 150px; height: 15px; background: #444; border: 2px solid #fff; border-radius: 10px; overflow: hidden; }
        .hp-fill { width: 100%; height: 100%; background: #ff4757; transition: 0.3s; }
        .name { color: white; font-size: 14px; margin-bottom: 5px; text-shadow: 1px 1px 2px #000; }
        .power-tag { color: #ffa502; font-size: 12px; font-weight: bold; display: none; }

        /* çµç®— */
        #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 300;
        }
        #result-title { font-size: 60px; color: gold; margin-bottom: 20px; }
        .btn {
            padding: 15px 40px; font-size: 24px; background: #e67e22;
            color: white; border: none; border-radius: 5px; cursor: pointer;
        }
        #instruction {
            position: absolute; bottom: 20px; color: rgba(255,255,255,0.5); font-size: 14px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="refresh-hint">â¬‡ï¸ ä¸‹æ‹‰é‡æ–°æ•´ç†ç¶²é  â¬‡ï¸</div>

    <div id="ui-overlay">
        <div class="hp-box">
            <div class="name">æˆ‘æ–¹æ­¦å£« ğŸ¥· <span id="p1-power" class="power-tag">POWER UP!</span></div>
            <div class="hp-bar"><div id="p1-hp" class="hp-fill" style="background: #2ecc71;"></div></div>
        </div>
        <div class="hp-box">
            <div class="name">æ•µæ–¹å¿è€… ğŸ‘¹ <span id="p2-power" class="power-tag">POWER UP!</span></div>
            <div class="hp-bar"><div id="p2-hp" class="hp-fill"></div></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="instruction">æ»‘å‹•ï¼šç§»å‹•/è·³èº | é»æ“Šï¼šæ”»æ“Š | ä¸‹æ‹‰ï¼šé‡ä¾†</div>

    <div id="result-screen">
        <div id="result-title">å‹è² å·²åˆ†</div>
        <button class="btn" onclick="location.reload()">å†æˆ°æ±Ÿæ¹–</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800;
    canvas.height = 500;

    // --- ç‰©ç†å¸¸æ•¸ ---
    const gravity = 0.8;
    const friction = 0.85;
    let gameActive = true;

    // --- åœ°å‹ ---
    const platforms = [
        { x: 100, y: 400, w: 600, h: 20 },
        { x: 50, y: 280, w: 200, h: 15 },
        { x: 550, y: 280, w: 200, h: 15 },
        { x: 300, y: 180, w: 200, h: 15 }
    ];

    // --- é“å…·ç³»çµ± ---
    class Item {
        constructor() {
            this.spawn();
        }
        spawn() {
            this.x = Math.random() * 600 + 100;
            this.y = -50;
            this.w = 30; this.h = 30;
            this.active = true;
        }
        draw() {
            if (!this.active) return;
            this.y += 2; // ç·©æ…¢è½ä¸‹
            platforms.forEach(p => {
                if (this.y + this.h > p.y && this.x > p.x && this.x < p.x + p.w && this.y < p.y) this.y = p.y - this.h;
            });
            ctx.fillStyle = "#ff4757";
            ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.strokeStyle = "gold";
            ctx.lineWidth = 3;
            ctx.strokeRect(this.x, this.y, this.w, this.h);
            ctx.fillStyle = "white";
            ctx.fillText("åŠ›", this.x + 10, this.y + 20);
        }
    }
    const powerUp = new Item();

    // --- å¿è€…é¡åˆ¥ ---
    class Ninja {
        constructor(x, y, color, isNPC) {
            this.initialX = x; this.initialY = y;
            this.color = color; this.isNPC = isNPC;
            this.reset();
        }
        reset() {
            this.x = this.initialX; this.y = this.initialY;
            this.w = 35; this.h = 50;
            this.dx = 0; this.dy = 0; this.hp = 100;
            this.facing = this.isNPC ? -1 : 1;
            this.jumpCount = 0;
            this.isAttacking = false;
            this.attackCooldown = 0;
            this.powerTimer = 0;
        }
        draw() {
            let currentW = this.powerTimer > 0 ? this.w * 1.3 : this.w;
            let currentH = this.powerTimer > 0 ? this.h * 1.3 : this.h;

            // ç•«åŠ
            if (this.isAttacking) {
                ctx.strokeStyle = this.powerTimer > 0 ? "orange" : "#fff";
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(this.x + currentW/2, this.y + currentH/2);
                ctx.lineTo(this.x + currentW/2 + (70 * this.facing), this.y + currentH/2);
                ctx.stroke();
            }

            // èº«é«”
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, currentW, currentH);
            // é ­å¸¶
            ctx.fillStyle = this.isNPC ? "#ff4757" : "#2ecc71";
            ctx.fillRect(this.x, this.y + 10, currentW, 8);
            // çœ¼ç›
            ctx.fillStyle = "white";
            let eyeX = this.x + (this.facing === 1 ? currentW - 12 : 5);
            ctx.fillRect(eyeX, this.y + 12, 8, 3);

            if (this.powerTimer > 0) this.powerTimer--;
            document.getElementById(this.isNPC ? 'p2-power' : 'p1-power').style.display = this.powerTimer > 0 ? 'inline' : 'none';
        }
        update() {
            this.dy += gravity; this.x += this.dx; this.y += this.dy; this.dx *= friction;
            platforms.forEach(p => {
                if (this.x + this.w > p.x && this.x < p.x + p.w && this.y + this.h > p.y && this.y + this.h < p.y + p.h + this.dy) {
                    if (this.dy >= 0) { this.dy = 0; this.y = p.y - this.h; this.jumpCount = 0; }
                }
            });
            if (this.x < 0) this.x = 0; if (this.x + this.w > canvas.width) this.x = canvas.width - this.w;
            if (this.y > canvas.height) { this.hp -= 20; this.y = 0; updateHP(); }
            if (this.attackCooldown > 0) this.attackCooldown--;
            if (this.attackCooldown < 10) this.isAttacking = false;

            // åƒåˆ°é“å…·
            if (powerUp.active && this.x < powerUp.x + powerUp.w && this.x + this.w > powerUp.x && this.y < powerUp.y + powerUp.h && this.y + this.h > powerUp.y) {
                this.powerTimer = 300; powerUp.active = false;
                setTimeout(() => { if(!gameActive) return; powerUp.spawn(); }, 5000);
            }
        }
        attack() {
            if (this.attackCooldown === 0) { this.isAttacking = true; this.attackCooldown = 20; return true; }
            return false;
        }
    }

    const player = new Ninja(200, 300, "#222", false);
    const npc = new Ninja(550, 300, "#444", true);

    // --- å…¨è¢å¹•æŒ‡æ»‘æ“æ§ ---
    let tStartX = 0, tStartY = 0;
    window.addEventListener('touchstart', e => {
        tStartX = e.touches[0].pageX;
        tStartY = e.touches[0].pageY;
    });

    window.addEventListener('touchend', e => {
        let tEndX = e.changedTouches[0].pageX;
        let tEndY = e.changedTouches[0].pageY;
        let dx = tEndX - tStartX;
        let dy = tEndY - tStartY;

        if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
            player.attack(); // é»æ“Šæ”»æ“Š
        } else if (dy < -50) {
            if (player.jumpCount < 2) { player.dy = -14; player.jumpCount++; } // å‘ä¸Šæ»‘è·³èº
        } else if (dx > 50) {
            player.dx = 15; player.facing = 1; // å‘å³æ»‘è¡åˆº
        } else if (dx < -50) {
            player.dx = -15; player.facing = -1; // å‘å·¦æ»‘è¡åˆº
        }
    });

    // --- ä¸‹æ‹‰é‡æ–°æ•´ç† (é‚è¼¯å»¶ç”¨) ---
    let pullStartY = 0;
    window.addEventListener('touchstart', e => pullStartY = e.touches[0].pageY);
    window.addEventListener('touchmove', e => {
        let dist = e.touches[0].pageY - pullStartY;
        if (dist > 100 && window.scrollY === 0) {
            document.getElementById('refresh-hint').style.top = '20px';
            if (dist > 200) location.reload();
        }
    });

    function updateHP() {
        document.getElementById('p1-hp').style.width = Math.max(0, player.hp) + '%';
        document.getElementById('p2-hp').style.width = Math.max(0, npc.hp) + '%';
    }

    function checkHit(a, v) {
        if (a.isAttacking && a.attackCooldown === 15) {
            let range = a.powerTimer > 0 ? 100 : 70;
            let dmg = a.powerTimer > 0 ? 25 : 10;
            let aMidX = a.x + a.w/2;
            let reach = aMidX + (a.facing * range);
            if (v.x < Math.max(aMidX, reach) && v.x + v.w > Math.min(aMidX, reach) && Math.abs(a.y - v.y) < 60) {
                v.hp -= dmg; v.dx = a.facing * (a.powerTimer > 0 ? 25 : 15); v.dy = -5; updateHP();
            }
        }
    }

    function gameLoop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // AI é‚è¼¯
        let dist = player.x - npc.x;
        if (Math.abs(dist) > 80) {
            npc.dx = dist > 0 ? 3 : -3; npc.facing = dist > 0 ? 1 : -1;
        } else {
            if (Math.random() < 0.05) npc.attack();
        }
        if (Math.random() < 0.01 && npc.jumpCount === 0) npc.dy = -12;

        player.update(); npc.update();
        checkHit(player, npc); checkHit(npc, player);

        // ç•«åœ°å‹
        ctx.fillStyle = "#34495e";
        platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

        powerUp.draw();
        player.draw(); npc.draw();

        if (player.hp <= 0 || npc.hp <= 0) {
            gameActive = false;
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('result-title').innerText = player.hp <= 0 ? "å‹æ•—ä¹ƒå¸¸äº‹" : "æ­¦é‹æ˜Œéš†ï¼";
        } else {
            requestAnimationFrame(gameLoop);
        }
    }

    gameLoop();
</script>
</body>
</html>
